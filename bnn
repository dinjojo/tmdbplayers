WITH Changes AS (
    SELECT 
        curr.marketId,
        curr.initiatedTS,
        curr.expireTS,
        curr.issueId AS curr_issueId,
        curr.rtSymbol AS curr_rtSymbol,
        curr.modifiedSrce AS curr_modifiedSrce,
        prev.issueId AS prev_issueId,
        prev.rtSymbol AS prev_rtSymbol,
        prev.modifiedSrce AS prev_modifiedSrce
    FROM 
        P2MarketHistory curr
    LEFT JOIN 
        P2MarketHistory prev 
        ON curr.marketId = prev.marketId 
        AND curr.initiatedTS = prev.expireTS -- Match consecutive records by time
)
SELECT 
    marketId,
    initiatedTS,
    expireTS,
    curr_issueId,
    curr_rtSymbol,
    prev_issueId,
    prev_rtSymbol,
    curr_modifiedSrce
FROM 
    Changes
WHERE 
    (curr_issueId != prev_issueId OR curr_rtSymbol != prev_rtSymbol) -- Detect a flip in the values
    AND EXISTS (
        -- Check if the issueId and rtSymbol have reverted back to their original values
        SELECT 1
        FROM Changes next_flip
        WHERE next_flip.marketId = Changes.marketId
        AND next_flip.initiatedTS = Changes.expireTS
        AND next_flip.curr_issueId = prev_issueId
        AND next_flip.curr_rtSymbol = prev_rtSymbol
    )
ORDER BY 
    marketId, initiatedTS;
